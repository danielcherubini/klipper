
[include klicky/klicky-probe.cfg]
[include nozzle_scrub.cfg]

[include TEST_SPEED.cfg]

[gcode_arcs]
resolution: 1.0

[gcode_macro M141]
gcode:
    # Orca sends M141 for chamber temp — already handled via PRINT_START CHAMBER_TEMP param

[gcode_macro CENTER]
gcode:
   G0 X175 Y175 Z30 F20000

[gcode_macro CALIBRATE_Z]
rename_existing: BASE_CALIBRATE_Z
gcode:
    {% if printer.quad_gantry_level.applied == False %}
        STATUS_LEVELING
        QUAD_GANTRY_LEVEL
    {% endif %}
    BASE_CALIBRATE_Z {rawparams}

[gcode_macro LEVEL_AND_CALIBRATE]
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(0)|int %}
    {% set mesh_name = "mesh-%d" % BED_TEMP %}

    STATUS_HOMING
    G90

    # 1. Home all axes unless already homed
    CHOME

    # 2. Wait for nozzle to get to 150'c
    M109 S150

    # 3. Nozzle Wipe
    STATUS_CLEANING
    NOZZLE_CLEAN

    # 4. Attach probe and lock
    ATTACH_PROBE_LOCK

    # 5. QGL
    STATUS_LEVELING
    QUAD_GANTRY_LEVEL

    # 6. Nozzle Wipe
    STATUS_CLEANING
    NOZZLE_CLEAN

    # 7. Home Z with cleaned nozzle
    G28 Z

    # 8. Calibrate Z
    STATUS_CALIBRATING_Z
    CALIBRATE_Z

    # 9. Bed Mesh — load saved profile or calibrate new (full-bed, bypasses KAMP)
    {% if BED_TEMP > 0 and mesh_name in printer.bed_mesh.profiles %}
        RESPOND MSG="Loading saved mesh profile: {mesh_name}"
        BED_MESH_PROFILE LOAD={mesh_name}
    {% else %}
        STATUS_MESHING
        _BED_MESH_CALIBRATE
        {% if BED_TEMP > 0 %}
            BED_MESH_PROFILE SAVE={mesh_name}
            RESPOND MSG="Saved new mesh profile: {mesh_name}"
        {% endif %}
    {% endif %}

    # 10. Dock probe and unlock
    DOCK_PROBE_UNLOCK

    STATUS_READY

[gcode_macro G32]
gcode:
    LEVEL_AND_CALIBRATE

[gcode_macro REMESH]
description: "Force a fresh bed mesh and save it. Run after changing bed, nozzle, etc."
gcode:
    {% set BED_TEMP = printer.heater_bed.target|int %}
    {% set mesh_name = "mesh-%d" % BED_TEMP %}

    {% if BED_TEMP == 0 %}
        {action_raise_error("Bed heater is off. Heat the bed first, then run REMESH.")}
    {% endif %}

    CHOME

    ATTACH_PROBE_LOCK

    STATUS_MESHING
    _BED_MESH_CALIBRATE
    BED_MESH_PROFILE SAVE={mesh_name}
    RESPOND MSG="Saved mesh profile: {mesh_name} — restarting to persist"

    DOCK_PROBE_UNLOCK

    SAVE_CONFIG

[gcode_macro PRINT_START]
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}
    {% set CHAMBER_TEMP = params.CHAMBER_TEMP|default(0)|float %}
    {% set total_layers = params.TOTAL_LAYERS|default(0)|int %}

    SET_PRINT_STATS_INFO TOTAL_LAYER={total_layers}

    UPDATE_DELAYED_GCODE ID=_BEDFANS_OFF DURATION=0  ; Cancel any pending fan shutoff

    CASELIGHT_ON

    # 1. Home all axes
    CHOME
    # 2. Set nozzle to 150°C (no-wait)
    M104 S150
    # 3. Set bed temp and WAIT
    M190 S{BED_TEMP}
    # 4. Heat soak — wait for chamber temp if target specified
    {% if CHAMBER_TEMP > 0 %}
        {% set current_chamber = printer["temperature_sensor chamber_temp"].temperature %}
        {% if current_chamber < CHAMBER_TEMP %}
            {action_respond_info("Heat soak: chamber at %.1f°C, waiting for %.1f°C" % (current_chamber, CHAMBER_TEMP))}
            STATUS_HEATING
            G90
            G1 X175 Y175 Z30 F6000
            TEMPERATURE_WAIT SENSOR="temperature_sensor chamber_temp" MINIMUM={CHAMBER_TEMP}
        {% else %}
            {action_respond_info("Chamber already at %.1f°C (target: %.1f°C) — skipping soak" % (current_chamber, CHAMBER_TEMP))}
        {% endif %}
    {% endif %}
    # 5. Level and Calibrate
    LEVEL_AND_CALIBRATE BED_TEMP={BED_TEMP}
    # 6. Park near print area
    Smart_Park
    # 7. Set and wait for nozzle to reach printing temperature
    M109 S{EXTRUDER_TEMP}
    # 8. Smart Purge
    LINE_PURGE

    STATUS_PRINTING

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 5, th.axis_maximum.z]|min %}

    SAVE_GCODE_STATE NAME=STATE_PRINT_END

    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-5.0 F1800                 ; retract filament

    TURN_OFF_HEATERS

    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X309 Y350 Z{z_safe} F3600  ; park nozzle at rear

    M107                                     ; turn off fan
  
    BED_MESH_CLEAR

    # Turn on bed fans for cooldown
    SET_FAN_SPEED FAN=BedFans SPEED=1.0
    UPDATE_DELAYED_GCODE ID=_BEDFANS_OFF DURATION=900  ; 15 minutes

    # Reset velocity limits
    SET_VELOCITY_LIMIT ACCEL={printer.configfile.settings.printer.max_accel}
    SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity}
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={printer.configfile.settings.printer.square_corner_velocity}
    
    STATUS_READY
    
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END

[delayed_gcode _BEDFANS_OFF]
gcode:
    SET_FAN_SPEED FAN=BedFans SPEED=0
    M117 Bed fans off

[gcode_macro AFTER_LAYER_CHANGE]
description: Report layer change to KlipperScreen
gcode:
    {% set current_layer = params.LAYER|default(0)|int %}
    {% set total_layers = printer.print_stats.info.total_layer|default(0)|int %}
    
    SET_PRINT_STATS_INFO CURRENT_LAYER={current_layer}
    
    # Display layer info on KlipperScreen
    {% if total_layers > 0 %}
        M117 Layer {current_layer}/{total_layers}
    {% else %}
        M117 Layer {current_layer}
    {% endif %}

[gcode_macro CHOME]
description: Homes XYZ axis only if printer is in a non-homed state
gcode:
  {% if "xyz" not in printer.toolhead.homed_axes %}
    G28
  {% endif %}

[gcode_macro FRONT]
description: Moves the toolhead to the front
gcode:
  CHOME
  {% set x_center = printer.toolhead.axis_maximum.x|float / 2.0 %}
  {% set y_center = printer.toolhead.axis_maximum.y|float / 2.0 %}
  G90
  G1 X{x_center} Y10 Z60 F7800

[gcode_macro _LOGO_PENDING]
gcode:
  SET_LED LED=sb_leds RED=0.15 GREEN=0.5 BLUE=0.75 WHITE=0 INDEX=1

[gcode_macro _LOGO_READY]
gcode:
  SET_LED LED=sb_leds RED=0.99 GREEN=0.0 BLUE=0.0 WHITE=0 INDEX=1

[gcode_macro _LOGO_OFF]
gcode:
  SET_LED LED=sb_leds RED=0 GREEN=0 BLUE=0 WHITE=0 INDEX=1


[gcode_macro _HEADLIGHT_ON]
gcode:
  SET_LED LED=sb_leds RED=1 GREEN=1 BLUE=1 WHITE=1.0 INDEX=2 TRANSMIT=0
  SET_LED LED=sb_leds RED=1 GREEN=1 BLUE=1 WHITE=1.0 INDEX=3


[gcode_macro _HEADLIGHT_OFF]
gcode:
  SET_LED LED=sb_leds RED=0 GREEN=0 BLUE=0 WHITE=0 INDEX=2 TRANSMIT=0
  SET_LED LED=sb_leds RED=0 GREEN=0 BLUE=0 WHITE=0 INDEX=3


[gcode_macro UNLOAD_FILAMENT]
description: Unloads filament from toolhead
gcode:
  {% set EXTRUDER_TEMP = params.TEMP|default(230)|int %}
  {% set MIN_TEMP = params.TEMP|default(230)|float * 0.98 %}
  {% set CURRENT_TARGET = printer.extruder.target|float %}
  CHOME
  G91                         ; relative positioning
  G1 Z20                      ; move nozzle upwards

  G90

  NOZZLE_PARK_BUCKET

  {% if EXTRUDER_TEMP != 0 %}
    _LOGO_PENDING
    {% if CURRENT_TARGET < EXTRUDER_TEMP %}
      M104 S{EXTRUDER_TEMP} ; only heat up if the current extruder is not already hot
    {% endif %}
    TEMPERATURE_WAIT SENSOR="extruder" MINIMUM={MIN_TEMP} ; wait for min extrude temp to reach
  {% endif %}
  _LOGO_READY
  M83                         ; set extruder to relative mode
  G1 E10 F300                 ; extrude a little to soften tip
  G1 E-8 F3600                ; quickly retract a small amount to elimate stringing
  G4 P200                     ; pause for a short amount of time
  G1 E-50 F400                ; retract slowly the rest of the way
  G1 E-20 F300
  M400                        ; wait for moves to finish
  M117 Unload Complete!
  _LOGO_OFF

[gcode_macro LOAD_FILAMENT]
description: Loads new filament into toolhead
gcode:
  {% set EXTRUDER_TEMP = params.TEMP|default(230)|int %}
  {% set MIN_TEMP = params.TEMP|default(230)|float * 0.98 %}
  {% set CURRENT_TARGET = printer.extruder.target|float %}
  
  NOZZLE_PARK_BUCKET
  
  {% if EXTRUDER_TEMP != 0 %}
    _LOGO_PENDING
    {% if CURRENT_TARGET < EXTRUDER_TEMP %}
      M104 S{EXTRUDER_TEMP} ; only heat up if the current extruder is not already hot
    {% endif %}
    TEMPERATURE_WAIT SENSOR="extruder" MINIMUM={MIN_TEMP} ; wait for min extrude temp to reach
  {% endif %}
  _LOGO_READY
  _HEADLIGHT_ON
  M83                         ; set extruder to relative mode
  G1 E50 F300                 ; extrude slowlyL
  G1 E50 F300
  M400                        ; wait for moves to finish
  
  M117 Load Complete!
  _LOGO_OFF
  _HEADLIGHT_OFF

# [gcode_macro T0]
# gcode:

[gcode_macro PURGE_BLOB]
description: Purges filament into a blob over the bucket
gcode:
    # Parameters
    {% set PURGE_AMOUNT = params.PURGE|default(150)|int %}
    {% set TEMP = params.TEMP|default(0)|int %}
    {% set MIN_PURGE_TEMP = 200 %}                               # Minimum safe purge temp
    
    # Blob position - adjust to center over your bucket
    {% set BLOB_X = 310 %}
    {% set BLOB_Y = 320 %}
    {% set BLOB_Z_START = 3 %}
    {% set BLOB_Z_END = 20 %}
    
    # Speeds
    {% set PURGE_SPEED = 300 %}
    {% set TRAVEL_SPEED = 9000 %}
    {% set Z_SPEED = 1500 %}
    
    # Purge stepping
    {% set PURGE_STEPS = 5 %}
    {% set PURGE_PER_STEP = PURGE_AMOUNT / PURGE_STEPS %}
    {% set Z_PER_STEP = (BLOB_Z_END - BLOB_Z_START) / PURGE_STEPS %}
    
    # Get current state
    {% set current_temp = printer.extruder.temperature %}
    {% set target_temp = printer.extruder.target %}
    
    # Safety checks
    {% if "xyz" not in printer.toolhead.homed_axes %}
        { action_raise_error("Printer must be homed before PURGE_BLOB") }
    {% endif %}
    
    # Determine what temp to use
    {% if TEMP > 0 %}
        # User specified a temp - use it (but enforce minimum)
        {% set purge_temp = [TEMP, MIN_PURGE_TEMP]|max %}
    {% elif target_temp >= MIN_PURGE_TEMP %}
        # Target is already set high enough - use that
        {% set purge_temp = target_temp %}
    {% elif current_temp >= MIN_PURGE_TEMP %}
        # Currently hot enough - proceed without waiting
        {% set purge_temp = 0 %}
    {% else %}
        # Nothing is hot enough - error out
        { action_raise_error("Extruder too cold (%.0f°C). Specify TEMP or heat extruder to at least %d°C" % (current_temp, MIN_PURGE_TEMP)) }
    {% endif %}
    
    SAVE_GCODE_STATE NAME=PURGE_BLOB_STATE
    
    # Move to blob position (can do while heating)
    G90
    G1 X{BLOB_X} Y{BLOB_Y} F{TRAVEL_SPEED}
    G1 Z{BLOB_Z_START} F{Z_SPEED}
    
    # Heat and wait if needed
    {% if purge_temp > 0 %}
        M109 S{purge_temp}
    {% endif %}
    
    M83                                         ; Relative extrusion
    
    # Build the blob with rising Z
    {% for step in range(PURGE_STEPS) %}
        G1 E{PURGE_PER_STEP} F{PURGE_SPEED}
        G1 Z{BLOB_Z_START + ((step + 1) * Z_PER_STEP)} F{Z_SPEED}
    {% endfor %}
    
    # Retract and break string
    G1 E-2 F1800
    G4 P500
    G1 Z{BLOB_Z_END - 3} F{Z_SPEED}
    G1 Z{BLOB_Z_END + 15} F6000
    
    # Wiggle to ensure clean break
    G1 X{BLOB_X - 5} F{TRAVEL_SPEED}
    G1 X{BLOB_X} F{TRAVEL_SPEED}
    
    RESTORE_GCODE_STATE NAME=PURGE_BLOB_STATE
    
    NOZZLE_PARK_BUCKET

