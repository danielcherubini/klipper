
[include klicky/klicky-probe.cfg]
[include nozzle_scrub.cfg]

[gcode_macro CENTER]
gcode:
   G0 X175 Y175 Z30 F20000

[gcode_macro CALIBRATE_Z]
rename_existing: BASE_CALIBRATE_Z
gcode:
    BASE_CALIBRATE_Z {rawparams}

[gcode_macro LEVEL_AND_CALIBRATE]
gcode:
    STATUS_HOMING
    G90
    # 1. Home all axes unless already homed
    CHOME
    # 2. Wait for nozzle to get to 150'c
    M109 S150
    # 3. Nozzle Wipe
    STATUS_CLEANING
    CLEAN_NOZZLE
    # 4. Home Z with cleaned nozzle
    # G28 Z
    # 5. Attach probe and lock
    ATTACH_PROBE_LOCK
    # 6. QGL if not already QGLd (only if QGL section exists in config)
    # {% if printer.configfile.settings.quad_gantry_level %}
    #   {% if printer.quad_gantry_level.applied == False %}
        STATUS_LEVELING
        QUAD_GANTRY_LEVEL
        G28 Z
    #   {% endif %}
    # {% endif %} 
    # 7. Calibrate Z 
    STATUS_CALIBRATING_Z
    CALIBRATE_Z
    # 8. Adaptive Bed Mesh
    STATUS_MESHING
    BED_MESH_CALIBRATE ADAPTIVE=1
    # 9. Dock probe and unlock
    DOCK_PROBE_UNLOCK

    STATUS_READY

[gcode_macro G32]
gcode:
    LEVEL_AND_CALIBRATE

[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}
    {% set total_layers = params.TOTAL_LAYERS|default(0)|int %}

    SET_PRINT_STATS_INFO TOTAL_LAYER={total_layers}

    CASELIGHT_ON

    # 1. Home all axes
    G28
    # 2. Set nozzle to 150Â°C (no-wait) to soften filament for homing
    M104 S150
    # 3. Set bed temp and WAIT for it to heat up
    M190 S{BED_TEMP}
    # 4. Level and Calibrate
    LEVEL_AND_CALIBRATE
    # 5. Park near print area
    Smart_Park
    # 6. Set and wait for nozzle to reach printing temperature
    M109 S{EXTRUDER_TEMP}
    # 7. Smart Purge
    LINE_PURGE
    
    STATUS_PRINTING

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 5, th.axis_maximum.z]|min %}

    SAVE_GCODE_STATE NAME=STATE_PRINT_END

    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-5.0 F1800                 ; retract filament

    TURN_OFF_HEATERS

    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X309 Y350 Z{z_safe} F3600  ; park nozzle at rear

    M107                                     ; turn off fan
  
    BED_MESH_CLEAR

    # Reset velocity limits
    SET_VELOCITY_LIMIT ACCEL={printer.configfile.settings.printer.max_accel}
    SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity}
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={printer.configfile.settings.printer.square_corner_velocity}
    
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END

[gcode_macro AFTER_LAYER_CHANGE]
description: Report layer change to KlipperScreen
gcode:
    {% set current_layer = params.LAYER|default(0)|int %}
    SET_PRINT_STATS_INFO CURRENT_LAYER={current_layer}
    # You can add other things here later (like timelapse triggers)

[gcode_macro CHOME]
description: Homes XYZ axis only if printer is in a non-homed state
gcode:
  {% if "xyz" not in printer.toolhead.homed_axes %}
    G28
  {% endif %}

[gcode_macro FRONT]
description: Moves the toolhead to the front
gcode:
  CHOME
  {% set x_center = printer.toolhead.axis_maximum.x|float / 2.0 %}
  {% set y_center = printer.toolhead.axis_maximum.y|float / 2.0 %}
  G90
  G1 X{x_center} Y10 Z60 F7800

[gcode_macro _LOGO_PENDING]
gcode:
  SET_LED LED=sb_leds RED=0.15 GREEN=0.5 BLUE=0.75 WHITE=0 INDEX=1

[gcode_macro _LOGO_READY]
gcode:
  SET_LED LED=sb_leds RED=0.99 GREEN=0.0 BLUE=0.0 WHITE=0 INDEX=1

[gcode_macro _LOGO_OFF]
gcode:
  SET_LED LED=sb_leds RED=0 GREEN=0 BLUE=0 WHITE=0 INDEX=1


[gcode_macro _HEADLIGHT_ON]
gcode:
  SET_LED LED=sb_leds RED=1 GREEN=1 BLUE=1 WHITE=1.0 INDEX=2 TRANSMIT=0
  SET_LED LED=sb_leds RED=1 GREEN=1 BLUE=1 WHITE=1.0 INDEX=3


[gcode_macro _HEADLIGHT_OFF]
gcode:
  SET_LED LED=sb_leds RED=0 GREEN=0 BLUE=0 WHITE=0 INDEX=2 TRANSMIT=0
  SET_LED LED=sb_leds RED=0 GREEN=0 BLUE=0 WHITE=0 INDEX=3


[gcode_macro UNLOAD_FILAMENT]
description: Unloads filament from toolhead
gcode:
  {% set EXTRUDER_TEMP = params.TEMP|default(230)|int %}
  {% set MIN_TEMP = params.TEMP|default(230)|float * 0.98 %}
  {% set CURRENT_TARGET = printer.extruder.target|float %}
  CHOME
  G91                         ; relative positioning
  G1 Z20                      ; move nozzle upwards
  FRONT                       ; move the toolhead to the front
  {% if EXTRUDER_TEMP != 0 %}
    _LOGO_PENDING
    {% if CURRENT_TARGET < EXTRUDER_TEMP %}
      M104 S{EXTRUDER_TEMP} ; only heat up if the current extruder is not already hot
    {% endif %}
    TEMPERATURE_WAIT SENSOR="extruder" MINIMUM={MIN_TEMP} ; wait for min extrude temp to reach
  {% endif %}
  _LOGO_READY
  M83                         ; set extruder to relative mode
  G1 E10 F300                 ; extrude a little to soften tip
  G1 E-8 F3600                ; quickly retract a small amount to elimate stringing
  G4 P200                     ; pause for a short amount of time
  G1 E-50 F400                ; retract slowly the rest of the way
  G1 E-20 F300
  M400                        ; wait for moves to finish
  M117 Unload Complete!
  _LOGO_OFF

[gcode_macro LOAD_FILAMENT]
description: Loads new filament into toolhead
gcode:
  {% set EXTRUDER_TEMP = params.TEMP|default(230)|int %}
  {% set MIN_TEMP = params.TEMP|default(230)|float * 0.98 %}
  {% set CURRENT_TARGET = printer.extruder.target|float %}
  FRONT                       ; move the toolhead to the front
  {% if EXTRUDER_TEMP != 0 %}
    _LOGO_PENDING
    {% if CURRENT_TARGET < EXTRUDER_TEMP %}
      M104 S{EXTRUDER_TEMP} ; only heat up if the current extruder is not already hot
    {% endif %}
    TEMPERATURE_WAIT SENSOR="extruder" MINIMUM={MIN_TEMP} ; wait for min extrude temp to reach
  {% endif %}
  _LOGO_READY
  _HEADLIGHT_ON
  M83                         ; set extruder to relative mode
  G1 E50 F300                 ; extrude slowlyL
  G1 E50 F300
  M400                        ; wait for moves to finish
  M117 Load Complete!
  _LOGO_OFF
  _HEADLIGHT_OFF

[include TEST_SPEED.cfg]